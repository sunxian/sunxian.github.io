---
layout: post
title:  "前后端分离CAS单点登出"
description: "前后端分离CAS单点登出"
date:   2024-11-01 12:52:00 +0800
category: java
tags: [java, cas]
---
#  前后端分离CAS单点登出

### 前后端不分离

![img](https://cdn.nlark.com/yuque/0/2024/png/22580150/1729497800023-c296f576-14f3-4fec-95e8-1c05cd1ab72b.png)





### 前后端分离

![img](https://cdn.nlark.com/yuque/0/2024/png/22580150/1729497610892-a3262182-29d3-4619-bd89-ea566616747d.png)





### 实现登出的要点

1. **清除客户端存储**：

- - 清除客户端存储的JWT

1. **使Token失效**：

- - 当生成一个新的JWT时，将其添加到Redis的白名单中，并设置一个过期时间（通常与JWT的有效期相同。当用户执行登出操作时，将此JWT从Redis的白名单中移除。

1. **全局登出通知**：

- - 通知其他相关服务执行登出用户



### 实现流程

- **用户请求登出**：

- - 用户点击前端的“登出”按钮，发起登出操作。

- **前端向后端发送登出请求**：

- - 前端将带有当前 JWT 的登出请求发送到后端。后端通过JWT中的携带的信息去做退出。

- **后端处理登出请求**：

- - 后端通知 CAS 认证服务器，CAS服务通知各个应用登出。（失效token，清除权限缓存）

- **后端响应登出成功**：

- - 后端处理完登出逻辑后，返回登出成功的响应给前端。

- **前端清理 JWT**：

- - 前端在收到后端的成功响应后，清除所有存储的cookie

- **前端重定向到登录页**：

- - 前端清理完 JWT 后，可以重定向用户到登录页面，或者显示用户已登出的提示。

### 具体问题与方案

#### 如何实现浏览器级别的精确退出？

**问题背景：**

在同一用户使用两个不同的浏览器登录后台应用时，后端应用会为每个浏览器生成一个Access Token。当用户在一个浏览器中退出登录时，我们希望仅使该浏览器的Access Token失效，而不影响另一个浏览器的Access Token有效性。



**解决方案：**

为了实现浏览器级别的精确退出，我们需要引入一种机制，使得后端生成的Access Token与某个类似于会话标识符（Session ID）的唯一值进行绑定。在这个方案中，我们将使用CAS中的Ticket Granting Ticket（TGT）作为该唯一值，TGT是一个UUID形式的标识符。



**具体方案：**

1.TGT与Access Token的绑定：

当用户通过某个浏览器登录时，后端应用会生成一个JWT Access Token，并将其与CAS在登录过程中生成的TGT进行关联绑定。

- 存储在Redis中，并使用TGT作为键（Key），Access Token作为值（Value）进行绑定。这样，在用户登出时，只需根据TGT从Redis中删除对应的Access Token
- 生成的JWT Access Token 包含TGT

2.退出登录时的处理：

当用户在一个浏览器中执行退出登录操作时，前端应用将当前浏览器的TGT传递给CAS。

CAS根据接收到的TGT，通知与之关联的所有后端应用使相应的Access Token失效。